# Repo Audit — 2026-02-21

## FIXED

- [x] #1 — `'income'` key mismatch (commit 519e7ac)
- [x] #2 — RIM terminal value inflated ~5-10x (commit 6020401)
- [x] #3 — Growth DCF double-counts growth capex (commit 849f006)
- [x] #4 — Growth DCF uses Revenue as EBIT fallback (commit 849f006)
- [x] #5 — Backtesting Sharpe/Volatility ~8x wrong (commit 6d0b040)
- [x] #7 — Duplicate valuation rows → FALSE ALARM, schema has ON CONFLICT REPLACE
- [x] #8 — Negative FCF → silent garbage (commit 676770f)
- [x] #9 — Negative growth → +5% default (commit 676770f)
- [x] #10 — Division by zero guard (commit 676770f)
- [x] #11 — Stale exchange rates → live fetch with fallback (commit 33d6ed9)
- [x] #12 — D/E unit heuristic removed, risk thresholds fixed (commit 33d6ed9)
- [x] #14 — Fake interest coverage removed (commit 4b72f9f)
- [x] #15 — Circular P/FCF and EV/EBIT proxies removed (commit b59c868)
- [x] #16 — Scanner now notifies for all above-threshold stocks (commit b59c868)
- [x] #18 — Inverse normalization fix (commit b59c868)
- [x] #19 — ROIC formula fixed (commit 4b72f9f)
- [x] #20 — Growth CAGR docstring/naming clarified (commit 4b72f9f)
- [x] #21 — Beta now read from data first (commit b59c868)

---

## CRITICAL BUGS (silently producing wrong numbers)

### 1. `'income'` key never exists — multiple models get `None`
- **Where:** `base.py:257` stores yfinance's `stock.financials` (the income statement DataFrame) under key `'financials'`
- **But:** `rim_model.py:27,51,177`, `growth_dcf_model.py:288,311,378`, `lstm_transformer_model.py:364` all read `data.get('income')` → always `None`
- **Impact:** RIM and Growth DCF bail out or fall back on missing data for every stock
- **Fix:** Replace `data.get('income')` → `data.get('financials')` in all three files; update `rim_model.py:51` required fields list

### 2. RIM terminal value is ~5-10x inflated
- **Where:** `rim_model.py:99` — `terminal_book_value = projected_book_values[-1] * (1 + roe)`
- **Problem:** Grows terminal book value by full ROE (15-25%) instead of terminal growth rate (2.5%)
- **Fix:** `(1 + roe)` → `(1 + terminal_growth)`

### 3. Growth DCF double-counts growth capex
- **Where:** `growth_dcf_model.py:121-127`
- **Problem:** Base business FCF projected using growth rate that already embeds capex returns, then a separate perpetuity for growth capex added on top
- **Impact:** Systematic overvaluation of reinvestment-heavy companies

### 4. Growth DCF uses Revenue as EBIT fallback
- **Where:** `growth_dcf_model.py:383` — `'Operating Revenue'` in EBIT fallback list
- **Impact:** ROIC computed from revenue (not operating income), 5-20x too high
- **Fix:** Remove `'Operating Revenue'` from the fallback list

### 5. Backtesting Sharpe/Volatility is ~8x wrong
- **Where:** `backtesting/core/metrics.py:56-64`
- **Problem:** Annualizes with `sqrt(252)` (daily) but data is at rebalance frequency (quarterly=4/year)
- **Fix:** Detect data frequency, use correct `sqrt(periods_per_year)`

### 6. Backtesting uses current fundamentals for historical dates
- **Where:** `backtesting/data/historical.py:175-232`
- **Problem:** `yf.Ticker(ticker).info` returns 2026 data regardless of backtest date
- **Impact:** All quality/value factor backtests have severe look-ahead bias
- **Fix:** Use `fundamental_history` table for point-in-time data (19,864 rows already exist)

### 7. Duplicate valuation rows on re-run
- **Where:** `run_classic_valuations.py:51`
- **Problem:** `INSERT` not `INSERT OR REPLACE`
- **Fix:** Change to `INSERT OR REPLACE`

---

## HIGH-SEVERITY ISSUES

### 8. Negative FCF → silent garbage
- `dcf_model.py:87-91`: negative FCF projected forward with increasingly negative values + negative terminal value, no warning

### 9. Negative growth → +5% default
- `dcf_model.py:195-201`: shrinking companies silently get +5% growth rate

### 10. Division by zero risk (wacc <= terminal_growth)
- `dcf_model.py:91`, `rim_model.py:104`, multi-stage DCF, growth DCF — no guard for negative-beta stocks

### 11. Hardcoded stale exchange rates
- `currency_converter.py:16-37`: no timestamp, no live fallback, every non-USD metric potentially wrong

### 12. D/E unit heuristic is fragile
- `screening/quality.py:107-109`, `scanner/scoring.py:157,235`: `if de > 5 then divide by 100` misclassifies highly-leveraged companies (D/E 6x → treated as 6%) and foreign stocks

---

## MEDIUM-SEVERITY (scoring/screening gaps)

### 13. Quality scoring is binary (0 or 1)
- `screening/quality.py:75-125`: only 5 possible score values (0,25,50,75,100)

### 14. Interest coverage is fake
- `screening/quality.py:38-43`: returns hardcoded buckets (10/5/2) based on D/E, never checks actual interest expense

### 15. P/FCF and EV/EBIT are circular
- `screening/value.py:22-27,8-14`: `P/FCF = PE * 1.2`, `EV/EBIT = EV/EBITDA * 1.3` — zero new information

### 16. Scanner only notifies for #1 stock
- `opportunity_scanner.py:117-130`: even if 5 stocks exceed threshold, only top-ranked triggers notification

### 17. Black-Scholes uses market-derived EV as "fundamental" input
- `black_scholes_model.py:427-428`: Merton model output is circular when input is market-derived EV

### 18. Inverse normalization in scorer is wrong
- `scoring_engine.py:106-128`: `normalize(inverse=True)` flips value but compares against unflipped landmarks

### 19. ROIC formula is wrong
- `screening/quality.py:19`: `roic = roe / (1 + debt_ratio / 100)` — not a valid ROIC approximation

### 20. Growth CAGR function is not CAGR
- `screening/growth.py:6-15`: returns `revenue_growth * 0.85`, `years` param unused, function name misleading

### 21. Beta never read from data
- `screening/risk.py:51-75`: entirely estimated from sector/size, never uses `data.get("beta")` even though yfinance provides it

### 22. Banks double-penalized
- `screening/risk.py:94-100`: cyclical sector penalty + extreme D/E penalty makes all banks auto-reject

### 23. Cyclical adjustments are dead code
- `screening/risk.py:241-245`: writes `trailing_pe_adjusted` but nothing reads it

---

## VALUATION MODEL DETAIL NOTES

### Black-Scholes specific
- Rejects zero-debt companies (`black_scholes_model.py:105-107`) — can't value pristine balance sheets
- Zero equity vol → `sigma_asset` silently floored to 0.05 (`black_scholes_model.py:463`)
- Asset calibration iterates but initial guess may be clamped at extremes

### Simple Ratios specific
- `forwardPE`/`trailingPE` fetched but discarded — dead code (`ratios_model.py:217-219`)
- Population variance used instead of sample variance (`ratios_model.py:292-293`)

### Growth DCF specific
- ROIC > 100% rejects asset-light businesses (`growth_dcf_model.py:428-429`)
- Growth capex perpetuity: single year's capex → infinite returns, no depreciation
- Negative `normalized_fcf` produces negative EV silently (`growth_dcf_model.py:105`)

### Consensus
- `compute_consensus_from_dicts` doesn't filter `fv <= 0` (`consensus.py:182-187`)
- Confidence label counts models, ignores individual confidence scores (`consensus.py:141-146`)

---

## DATA PIPELINE ISSUES

### Stale/inconsistent data
- `currentPrice` used as gate but can be from stale cache (`data_fetcher.py:176-177`)
- `price_trend_30d` is bar-based not calendar-day-based (`data_fetcher.py:339`)
- JSON financial statements not currency-converted for USD-reporting ADRs (`data_fetcher.py:384-389`)
- `financialCurrency` never stored in DB — reader always returns `None` (`stock_data_reader.py:77-131`)
- `universal_fetcher.py` doesn't normalize D/E units (unlike `data_fetcher.py:292-300`)

### Pipeline ordering
- GBM runs before classic valuations in `update_all.py:109-123`
- Dashboard generated before opportunity scanner
- `ModelRegistry` re-instantiated per ticker per model (`run_classic_valuations.py:163`)

### Error handling
- SQLite connection not closed on exception (`run_classic_valuations.py:231-289`)
- 30s timeout shorter than retry backoff — kills retries (`data_fetcher.py:428,252`)
- JSON/SQLite inconsistency on write failure (`data_fetcher.py:164-165`)
- Missing `price_history` table crashes entire valuation run (`stock_data_reader.py:326-356`)
- Partial string matching returns wrong metric (`stock_data_reader.py:235-255`)

### Backtesting
- Survivorship bias — no delisting handling
- Final-row cash placeholder inflates turnover metric (`engine.py:199-208`)
- Intra-period drawdowns invisible (`metrics.py:67-71`)
- `win_rate` counts periods not trades (`metrics.py:77-80`)
- Beta/information ratio uses misaligned data frequencies (`metrics.py:169-183`)

---

## PROPOSALS: Catching Bigger Opportunities

### A. News/Sentiment/Catalyst Pipeline (new capability)
- Scrape SEC 8-K filings (material events), earnings transcripts, insider buying (Form 4)
- LLM-extract sentiment signals and catalyst summaries
- Feed into scanner — current `score_catalyst` only uses 52w-low proximity + analyst targets

### B. Monte Carlo Risk Module (quantify risk per position)
- Position-level VaR/CVaR from Monte Carlo DCF distributions (probabilistic_dcf.py exists but isn't integrated)
- Portfolio-level correlation-adjusted VaR
- Kelly-criterion position sizing based on model confidence

### C. Fix Backtesting Foundation (trust your signals)
- `sqrt(252)` → `sqrt(periods_per_year)`
- Use `fundamental_history` table for point-in-time fundamentals
- Add delisting/survivorship handling

### D. Earnings Quality / Accrual Detection
- `Accruals = (Net Income - Operating Cash Flow) / Total Assets`
- High accruals = low earnings quality (Enron-style warning)

### E. Insider Activity Tracking
- SEC Form 4 data is free via EDGAR (infrastructure already in `data/sec_edgar/`)
- Cluster insider buys = strongest turnaround signal

### F. Sector-Relative Scoring
- Replace absolute thresholds with sector percentile ranks
- "Cheap for its sector" instead of "P/E < 15"

### G. Macro Regime Awareness
- Yield curve inversion → weight defensives higher
- VIX regime → adjust opportunity threshold
- Credit spreads → detect risk-off environments

---

## QUICK WINS (1-line fixes, high ROI)

| Fix | File | Change |
|-----|------|--------|
| Income key mismatch | `rim_model.py`, `growth_dcf_model.py`, `lstm_transformer_model.py` | `data.get('income')` → `data.get('financials')` |
| RIM terminal inflation | `rim_model.py:99` | `(1 + roe)` → `(1 + terminal_growth)` |
| Duplicate rows | `run_classic_valuations.py:51` | `INSERT` → `INSERT OR REPLACE` |
| Sharpe ratio | `metrics.py:59` | Detect frequency, use correct `sqrt(N)` |
| Negative growth default | `dcf_model.py:195-201` | Allow negative growth, floor at -25% |
| Division by zero guard | `dcf_model.py:91` etc. | `if wacc <= terminal_growth: raise` |
| Revenue-as-EBIT | `growth_dcf_model.py:383` | Remove `'Operating Revenue'` from list |
